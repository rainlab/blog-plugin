+function(e){"use strict";var t=function(){this.$preview=e("#blog-post-preview");this.$form=this.$preview.closest("form");this.formAction=this.$form.attr("action");this.sessionKey=e("input[name=_session_key]",this.$form).val();this.$textarea=e('[name="Post[content]"]',this.$form);this.$previewContent=e(".preview-content",this.$preview);this.codeEditor=e('textarea[name="Post[content]"]',this.$form).closest(".field-codeeditor").data("oc.codeEditor");this.createIndicator();this.$textarea.on("oc.codeEditorChange",e.proxy(this.handleChange,this));this.loading=!1;this.updatesPaused=!1;this.initPreview();this.initDropzones();this.initFormEvents();this.initLayout()};t.prototype.handleChange=function(){if(this.updatesPaused)return;var e=this;if(this.loading){this.dataTrackInputTimer===undefined&&(this.dataTrackInputTimer=window.setInterval(function(){e.handleChange()},100));return}window.clearTimeout(this.dataTrackInputTimer);this.dataTrackInputTimer=undefined;var e=this;e.update()};t.prototype.createIndicator=function(){var t=e("#blog-post-preview").closest(".loading-indicator-container");this.$indicator=e('<div class="loading-indicator transparent"><div></div><span></span></div>');t.prepend(this.$indicator)};t.prototype.update=function(){var e=this;this.loading=!0;this.showIndicator();this.$form.request("onRefreshPreview",{success:function(t){e.$previewContent.html(t.preview);e.initPreview();e.updateScroll()}}).done(function(){e.hideIndicator();e.loading=!1})};t.prototype.showIndicator=function(){this.$indicator.css("display","block")};t.prototype.hideIndicator=function(){this.$indicator.css("display","none")};t.prototype.initPreview=function(){prettyPrint();this.initImageUploaders()};t.prototype.updateScroll=function(){this.$preview.data("oc.scrollbar").update()};t.prototype.initImageUploaders=function(){var t=this;e("span.image-placeholder .dropzone",this.$preview).each(function(){var n=e(this).parent(),r=e("input[type=file].file",n),i=n.data("index");r.fileupload({dropZone:e(this),url:t.formAction,paramName:"file",formData:{X_BLOG_IMAGE_UPLOAD:1,_session_key:t.sessionKey},done:function(r,s){if(s.result.error)alert(s.result.error);else{t.pauseUpdates();var o=e('<img src="'+s.result.path+'">');o.load(function(){t.updateScroll()});n.replaceWith(o);t.codeEditor.editor.replace("!["+s.result.file+"]("+s.result.path+")",{needle:"!["+i+"](image)"});t.resumeUpdates()}},fail:function(e,t){alert("Error uploading file.")},start:function(e,t){n.addClass("loading")},stop:function(e,t){n.removeClass("loading")}})})};t.prototype.pauseUpdates=function(){this.updatesPaused=!0};t.prototype.resumeUpdates=function(){this.updatesPaused=!1};t.prototype.initDropzones=function(){e(document).bind("dragover",function(t){var n=e("span.image-placeholder .dropzone"),r,i=window.dropZoneTimeout;i?clearTimeout(i):n.addClass("in");var s=!1,o=t.target;do{if(e(o).hasClass("dropzone")){s=!0;r=e(o);break}o=o.parentNode}while(o!=null);n.removeClass("in hover");s&&r.addClass("hover");window.dropZoneTimeout=setTimeout(function(){window.dropZoneTimeout=null;n.removeClass("in hover")},100)});e(document).on("click","#blog-post-preview span.dropzone",function(){e("input[type=file].trigger",e(this).parent()).click()});e(document).on("change","#blog-post-preview input[type=file].trigger",function(t){e("input[type=file].file",e(this).closest(".image-placeholder")).fileupload("add",{files:t.target.files||[{name:this.value}],fileInput:e(this)});e(this).val("")})};t.prototype.initFormEvents=function(){e(document).on("ajaxSuccess","#post-form",function(t,n,r){n.handler=="onSave"&&!r.X_OCTOBER_ERROR_FIELDS&&e(this).trigger("unchange.oc.changeMonitor")});e("#Datepicker-formPublishedAt-input-published_at").triggerOn({triggerCondition:"checked",trigger:"#Form-form-field-Post-published",triggerType:"enable"})};t.prototype.initLayout=function(){e("#Form-form-tabs-secondary .tab-pane.layout-cell:not(:first-child)").addClass("padded")};t.prototype.replacePlaceholder=function(e,t,n,r){this.pauseUpdates();e.replaceWith(t);this.codeEditor.editor.replace(r,{needle:n});this.updateScroll();this.resumeUpdates()};e(document).ready(function(){var n=new t;e.oc===undefined&&(e.oc={});e.oc.blogPostForm=n})}(window.jQuery);